<!doctype html>
<html>
<head>
<title>Mile web library test</title>
<script src="milecsa.js"></script>
<script>
    function printLine( str ) {
        const node = document.createElement("PRE")
        const out = document.createTextNode( str )
        node.appendChild( out )
        document.getElementsByTagName("BODY")[0].append( node )
        console.log( str )
    }
    
    Module['onRuntimeInitialized'] = function() {

        var error = new Module.Error()

        printLine("----  Pair tests  ----")

        var pair = new Module.Pair.Random(error)

        if (error.hasError) {
            printLine("Error: " + error.what)
        }

        printLine("Random private key: " + pair.private_key)
        printLine("Random public key : " + pair.public_key)

        var pair_with_secret = new Module.Pair.WithSecret("some secret phrase!", error);

        printLine("FromPrivateKey private key: " + pair_with_secret.private_key)
        printLine("FromPrivateKey public key : " + pair_with_secret.public_key)

        var pair_from_private_key = new Module.Pair.FromPrivateKey(pair_with_secret.private_key, error);

        printLine("FromPrivateKey private key: " + pair_from_private_key.private_key)
        printLine("FromPrivateKey public key : " + pair_from_private_key.public_key)

        if(!Module.Pair.Validate(pair_from_private_key, error)){
            printLine("Pair keys NOT validated: " + error.what)
        }
        else  {
            printLine("Pair keys validated")
        }

        if(!Module.Pair.ValidatePublicKey(pair_from_private_key.public_key, error)){
            printLine("Public key NOT validated: " + error.what)
        }
        else  {
            printLine("Public key validated")
        }

        if(!Module.Pair.ValidatePrivateKey(pair_from_private_key.private_key, error)){
            printLine("Private key NOT validated: " + error.what);
        }
        else  {
            printLine("Private key validated")
        }

        if(!Module.Pair.ValidatePublicKey('+' + pair_from_private_key.public_key, error)){
            printLine("Invalid public key NOT validated: " + error.what);
        }
        else  {
            printLine("Public key validated")
        }

        if(!Module.Pair.ValidatePrivateKey('--', error)){
            printLine("Imvalid private key NOT validated: " + error.what);
        }
        else  {
            printLine("Private key validated")
        }

        printLine("---- Transactions tests ----")

        var destination = Module.Pair.FromPrivateKey(pair_with_secret.private_key,error)

        if (!destination) {
            printLine("Destination pair error: " + error.what)
        }

        var transaction = new Module.Transaction()
        var ret =  transaction.Transfer(
            pair,                    // pair
            destination.public_key,  // destination
            "2",                     // block id
            "0",                     // transaction id
            0,                       // asset code
            "1000",                  // amount
            "memo field",            // description
            "",                      // fee, always ""
            error)                   // error

        printLine("Transaction transfer asset: " + (ret == Module.result.OK))

        printLine("Transaction transfer body: " + JSON.stringify( JSON.parse( transaction.body ), undefined, 2 ) )

        printLine("-------")

        ret =  transaction.Emission(
            pair,                    // pair
            destination.public_key,  // destination
            "2",                     // block id
            "0",                     // transaction id
            0,                       // asset code
            "1000",                  // amount
            "memo field",            // description
            "",                      // fee, always ""
            error)

        printLine("Transaction emission: " + (ret == Module.result.OK))

        printLine("Transaction emission body: " + JSON.stringify( JSON.parse( transaction.body ), undefined, 2 ) )
    };
</script>
</head>
<body>
    <pre id='out'></pre>
</body>
</html>
